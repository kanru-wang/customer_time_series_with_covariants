---
title: "customer_time_series_multivariate"
output: html_notebook
---

```{r}
library(readr)
library(forecast)
combined_clean <- read_csv("C:/Users/wangka3/Desktop/learning/R_exercise2/combined_clean.csv")
```

# The attempt to use ARIMAX.
```{r}
train_data = combined_clean[1:15912, 5:58]
test_data = combined_clean[15913:17376, 5:58]
```

```{r}
model_cust = auto.arima(combined_clean$cust_168[1:15912], 
                        xreg = data.matrix(train_data))
```

```{r}
model_cust
```


```{r}
checkresiduals(model_cust)
```

### ARIMA does not capture seasonality well. Need to use another model.
```{r}
forecast_cust = forecast(model_cust, xreg = data.matrix(train_data))
(autoplot(forecast_cust))
```

# Now use msts with seasonal periods equals to 24 hours and 24 * 7 = 168 hours.

* 15841 is the last row that has coherent time series data.
* 15913 is the first row of the test dataset.
* 17376 is the last row of the combined train/test dataset.
```{r}
cust <- msts(log(combined_clean$cust_168[1:15841] + 1), seasonal.periods=c(24,168))
model_cust <- tbats(cust)
(autoplot(forecast(model_cust, h = 17376 - 15841)))
```


```{r}
others <- msts(log(combined_clean$others_168[1:15841] + 1), seasonal.periods=c(24,168))
model_others <- tbats(others)
(autoplot(forecast(model_others, h = 17376 - 15841)))
```

# Output

Again, remember that:

* 15841 is the last row that has coherent time series data.
* 15913 is the first row of the test dataset.
* 17376 is the last row of the combined train/test dataset.
```{r}
pred_cust = forecast(model_cust, h = 17376 - 15841)
result_cust = exp(pred_cust$mean) - 1
result_cust = result_cust[(15913 - 15841) : (17376 - 15841)]
```

```{r}
pred_others = forecast(model_others, h = 17376 - 15841)
result_others = exp(pred_others$mean) - 1
result_others = result_others[(15913 - 15841) : (17376 - 15841)]
```




```{r}
train_data = combined_clean[1:15841, 5:58]
test_data = combined_clean[15842:17376, 5:58]
```

```{r}
cust <- msts(log(combined_clean$cust_168[1:15841] + 1), seasonal.periods=c(24,168))
model_cust_improved <- tbats(cust, xreg = data.matrix(train_data))
```

```{r}
(autoplot(forecast(model_cust_improved, h = 17376 - 15841, xreg = test_data)))
```



```{r}
z_cust <- fourier(cust, K=c(2,5))
zf_cust <- fourier(y, K=c(2,5), h=100)
fit <- auto.arima(y, xreg=cbind(z,holiday), seasonal=FALSE)
fc <- forecast(fit, xreg=cbind(zf,holidayf), h=100)
```

